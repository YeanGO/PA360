<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>老師評分</title>

  <link rel="stylesheet" href="/assets/styles.css">
  <script src="/assets/auth_guard.js"></script>
  <script src="/assets/layout.js"></script>

  <script>requireAuth(["teacher"]);</script>

  <style>
    .notice{ margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background: rgba(255,255,255,.03); color: var(--muted); }
    .notice.error{ border-color: rgba(239,68,68,.45); color: rgba(239,68,68,.95); }
    .notice.ok{ border-color: rgba(34,197,94,.35); color: rgba(34,197,94,.92); }
    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .divider{ height:1px; background: var(--border); margin:14px 0; }
  </style>
</head>

<body>
  <div id="app"></div>

  <script>
    renderLayout({ title: "老師評分（六指標 1–10）" });

    const METRICS = [
      { zh: "工作態度", key: "hp"  },
      { zh: "工作績效", key: "atk" },
      { zh: "紀律規範", key: "def" },
      { zh: "專業能力", key: "spa" },
      { zh: "學習成長", key: "spd" },
      { zh: "溝通協作", key: "spe" },
    ];

    const tokenType = (localStorage.getItem("token_type") || "bearer");
    const token = localStorage.getItem("access_token");
    const page = document.getElementById("page");

    function notice(msg, type=""){ return `<div class="notice ${type}">${msg}</div>`; }

    function buildMetricsHtml(defaultValue=7){
      return METRICS.map(m => `
        <label class="muted">${m.zh}</label>
        <div class="form-row">
          <input type="range" min="1" max="10" value="${defaultValue}" data-range="${m.key}">
          <input type="number" min="1" max="10" value="${defaultValue}" data-num="${m.key}">
        </div>
      `).join("");
    }

    function bindSync(){
      METRICS.forEach(m => {
        const r = document.querySelector(`[data-range="${m.key}"]`);
        const n = document.querySelector(`[data-num="${m.key}"]`);
        if (!r || !n) return;

        r.addEventListener("input", e => n.value = e.target.value);
        n.addEventListener("input", e => {
          const v = Math.max(1, Math.min(10, Number(e.target.value || 0)));
          e.target.value = v;
          r.value = v;
        });
      });
    }

    function collectScores(){
      const scores = {};
      METRICS.forEach(m => {
        const n = document.querySelector(`[data-num="${m.key}"]`);
        scores[m.key] = Math.max(1, Math.min(10, Number(n?.value || 0)));
      });
      return scores;
    }

    async function fetchStudents(){
      if (!token) throw new Error("no_token");

      const resp = await fetch("/api/teacher/students", {
        headers: { "Authorization": `${tokenType} ${token}` }
      });
      if (!resp.ok) throw new Error("students");
      return resp.json();
    }

    async function submitTeacherScore(payload){
      if (!token) throw new Error("no_token");
      const resp = await fetch("/api/scores/teacher", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `${tokenType} ${token}`
        },
        body: JSON.stringify(payload)
      });
      return resp;
    }

    function render(students, msgHtml=""){
      page.innerHTML = `
        <p class="muted">選擇學生，填寫六指標分數（1–10），送出後會存入 app.db：scores_teacher。</p>
        ${msgHtml}

        <div class="divider"></div>

        <div class="toolbar">
          <div style="min-width:220px; flex: 1 1 220px;">
            <label class="muted">選擇要評分的學生</label>
            <select id="target">
              ${students.map(s => `<option value="${s}">${s}</option>`).join("")}
            </select>
          </div>

          <div style="margin-top:22px;">
            <button class="btn" id="resetBtn" type="button">重設為 7</button>
          </div>
        </div>

        <form id="scoreForm" style="margin-top:12px;">
          ${buildMetricsHtml(7)}
          <div style="margin-top:14px;">
            <button class="btn primary" type="submit" id="submitBtn">送出老師評分</button>
          </div>

          <pre id="preview" class="card" style="margin-top:12px; white-space:pre-wrap;"></pre>
        </form>
      `;

      bindSync();

      function renderPreview(){
        const target = document.getElementById("target").value;
        const payload = { target_user_id: target, scores: collectScores() };
        document.getElementById("preview").textContent = JSON.stringify(payload, null, 2);
      }

      document.getElementById("target").addEventListener("change", renderPreview);
      METRICS.forEach(m => {
        const r = document.querySelector(`[data-range="${m.key}"]`);
        const n = document.querySelector(`[data-num="${m.key}"]`);
        r.addEventListener("input", renderPreview);
        n.addEventListener("input", renderPreview);
      });

      document.getElementById("resetBtn").addEventListener("click", () => {
        METRICS.forEach(m => {
          document.querySelector(`[data-range="${m.key}"]`).value = 7;
          document.querySelector(`[data-num="${m.key}"]`).value = 7;
        });
        renderPreview();
      });

      document.getElementById("scoreForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const btn = document.getElementById("submitBtn");
        btn.disabled = true;

        const target = document.getElementById("target").value;        
        const payload = { target_user_id: target, scores: collectScores() };


        try{
          const resp = await submitTeacherScore(payload);
          if (!resp.ok){
            let msg = `送出失敗（HTTP ${resp.status}）`;
            try{
              const err = await resp.json();
              const code = err?.detail?.error || "";
              if (code === "FORBIDDEN") msg = "你沒有權限送出（不是 teacher）。";
              if (code === "MISSING_TOKEN" || code === "INVALID_TOKEN") msg = "登入失效，請重新登入。";
            }catch(_){}
            render(students, notice(msg, "error"));
            return;
          }

          render(students, notice(`已送出對 <b>${target}</b> 的老師評分（已存入 app.db）`, "ok"));
        } finally {
          btn.disabled = false;
        }
      });

      renderPreview();
    }

    (async function main(){
      page.innerHTML = `<p class="muted">載入學生名單中...</p>`;
      try{
        const data = await fetchStudents();
        const students = data.students || [];
        if (!students.length){
          page.innerHTML = notice("users.csv 沒有 student 角色，請確認名單設定。", "error");
          return;
        }  
        render(students);
        }catch(e){
          if (String(e?.message) === "no_token"){
            page.innerHTML = notice("沒有登入 token，請先回登入頁重新登入。", "error");
          } else {
            page.innerHTML = notice("載入學生名單失敗，請確認後端已啟動且 teacher token 正確。", "error");
          }
          console.error(e);
        }
    })();
  </script>
</body>
</html>
